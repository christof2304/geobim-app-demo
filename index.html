<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>geobim.app | Geospatial BIM Viewer</title>

  <!-- Favicon Fix -->
  <link rel="icon" href="data:,">

  <!-- Privacy-friendly analytics by Plausible -->
  <script async src="https://plausible.io/js/pa-l_LicZpu1DpGT201Nqezw.js"></script>
  <script>
    window.plausible=window.plausible||function(){(plausible.q=plausible.q||[]).push(arguments)},plausible.init=plausible.init||function(i){plausible.o=i||{}};
    plausible.init()
  </script>

  <!-- Cesium Library -->
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.134/Build/Cesium/Cesium.js"></script>
  <link rel="stylesheet" href="https://cesium.com/downloads/cesiumjs/releases/1.134/Build/Cesium/Widgets/widgets.css">

  <!-- Firebase SDK removed - Demo mode uses localStorage -->

  <!-- Modern Styles -->
  <link rel="stylesheet" href="style.css">

  <!-- Auth Styles -->
  <link rel="stylesheet" href="auth-styles.css">

  <!-- Z-Offset Styles -->
  <link rel="stylesheet" href="integrated-zoffset-styles.css">

  <!-- Lighting v4.0 Styles -->
  <link rel="stylesheet" href="lighting-styles.css">

  <!-- Comments Styles -->
  <link rel="stylesheet" href="comments-styles.css">
</head>
<body>

  <!-- ============================================
       SPLASH SCREEN (Shows first!)
       ============================================ -->
  <div id="splashScreen" class="splash-screen">
    <div class="splash-content">
      <div class="splash-logo">üåç</div>
      <h1 class="splash-title">geobim.app</h1>
      <p class="splash-subtitle">Geospatial BIM Viewer Demo</p>
      <div class="splash-divider"></div>
      <p class="splash-copyright">¬© 2026 Christof Lorenz</p>
      <p class="splash-license">Personal & non-commercial use only.</p>
      <p class="splash-contact">Contact: info@geobim.app</p>
      <button id="enterDemoBtn" class="splash-button">Enter Demo</button>
      <p class="splash-cta">Want to use your own IFC/Revit models? <a href="mailto:info@geobim.app" class="splash-cta-link" onclick="if(typeof plausible!=='undefined')plausible('Contact Click')">Contact me</a></p>
      <p class="splash-privacy">üîí Privacy-friendly analytics (no cookies)</p>
    </div>
  </div>

  <!-- Login screen removed - Demo mode active -->

  <!-- ============================================
       MAIN APP (Hidden until logged in)
       ============================================ -->

  <!-- Main Cesium Container -->
  <div id="cesiumContainer" style="display: none;"></div>

  <!-- Sidebar Toggle Button -->
  <button id="sidebarToggle" class="sidebar-toggle at-edge" style="display: none;" title="Toggle sidebar (M)">‚ò∞</button>

  <!-- Modern Toolbar -->
  <div id="toolbar" class="collapsed" style="display: none;"></div>

  <!-- Custom Info Box -->
  <div id="infoBoxCustom"></div>

  <!-- Drawing Mode Indicator -->
  <div id="modeIndicator" class="mode-indicator">
    ‚úèÔ∏è DRAWING MODE ACTIVE - Click map to add polygon points
  </div>

  <!-- Hide Mode Indicator -->
  <div id="hideModeIndicator" class="mode-indicator">
    üôà HIDE MODE - Click on elements to hide (ESC or H to exit)
  </div>

  <!-- Comment Mode Indicator -->
  <div id="commentModeIndicator" class="mode-indicator">
    üí¨ COMMENT MODE - RIGHT-CLICK on 3D model to place comment (ESC or C to exit)
  </div>

  <!-- Status Indicator -->
  <div id="statusIndicator" class="status-indicator">
    Status updates will appear here
  </div>

  <!-- Comment Dialog -->
  <div id="commentDialog" style="position: absolute; display: none; background: rgba(26, 32, 44, 0.98); backdrop-filter: blur(10px); border-radius: 16px; padding: 24px; color: white; z-index: 200; box-shadow: 0 16px 48px rgba(0,0,0,0.6); min-width: 380px; max-width: 420px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
    <h4 style="margin-top: 0; margin-bottom: 20px; color: #667eea; font-size: 18px; font-weight: 700;" id="commentDialogTitle">New Comment</h4>

    <div style="margin-bottom: 16px;">
      <label style="display: block; font-size: 12px; color: rgba(255,255,255,0.7); margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Title *</label>
      <input type="text" id="commentTitleInput" placeholder="Comment title..." style="width: 100%; padding: 12px 14px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: white; box-sizing: border-box; font-size: 14px; transition: all 0.2s ease;">
    </div>

    <div style="margin-bottom: 16px;">
      <label style="display: block; font-size: 12px; color: rgba(255,255,255,0.7); margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Comment *</label>
      <textarea id="commentTextInput" placeholder="Your comment..." style="width: 100%; padding: 12px 14px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: white; min-height: 120px; resize: vertical; box-sizing: border-box; font-size: 14px; font-family: inherit; transition: all 0.2s ease;"></textarea>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
      <div>
        <label style="display: block; font-size: 12px; color: rgba(255,255,255,0.7); margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Category</label>
        <select id="commentCategory" style="width: 100%; padding: 10px 14px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: white; box-sizing: border-box; font-size: 14px;">
          <option value="General">üìã General</option>
          <option value="Architecture">üèõÔ∏è Architecture</option>
          <option value="Structure">üóø Structure</option>
          <option value="MEP">‚ö° MEP</option>
          <option value="Issue">‚ö†Ô∏è Issue</option>
          <option value="Question">‚ùì Question</option>
        </select>
      </div>

      <div>
        <label style="display: block; font-size: 12px; color: rgba(255,255,255,0.7); margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Priority</label>
        <select id="commentPriority" style="width: 100%; padding: 10px 14px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: white; box-sizing: border-box; font-size: 14px;">
          <option value="Low">‚ö™ Low</option>
          <option value="Normal" selected>üîµ Normal</option>
          <option value="High">üî¥ High</option>
        </select>
      </div>
    </div>

    <div style="display: flex; gap: 12px;">
      <button onclick="BimViewer.closeCommentDialog()" style="flex: 1; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); padding: 12px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s ease;">
        Cancel
      </button>
      <button onclick="BimViewer.saveCommentFromDialog()" style="flex: 1; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border: none; padding: 12px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; box-shadow: 0 4px 12px rgba(17, 153, 142, 0.3); transition: all 0.2s ease;">
        Save Comment
      </button>
    </div>
  </div>

  <style>
    #commentDialog input:focus,
    #commentDialog textarea:focus,
    #commentDialog select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      background: rgba(255,255,255,0.08);
    }

    #commentDialog button:hover {
      transform: translateY(-1px);
    }

    #commentDialog button:active {
      transform: translateY(0);
    }

    #commentDialog button:last-child:hover {
      box-shadow: 0 6px 16px rgba(17, 153, 142, 0.4);
    }
  </style>

  <!-- ============================================
       JAVASCRIPT MODULES - LOAD ORDER IS CRITICAL!
       ============================================ -->

  <!-- Auth Module (FIRST!) -->
  <script src="auth.js"></script>

  <!-- 1. Core Modules (Foundation) -->
  <script src="core.js"></script>
  <script src="features.js"></script>
  <script src="hideFeatures.js"></script>
  <script src="comments.js"></script>
  <script src="pointcloud.js"></script>
  <script src="measurement.js"></script>

  <!-- 2. Enhanced Clipping Module -->
  <script src="clipping.js"></script>

  <!-- 3. Z-Offset Module v2.0 -->
  <script src="z-offset.js"></script>

  <!-- ============================================
       LIGHTING v4.0 - NEW SETUP
       ============================================ -->

  <!-- 4. Lighting Module v4.0 (MUST be loaded FIRST!) -->
  <script src="lighting.js"></script>

  <!-- ============================================
       UI MODULES
       ============================================ -->

  <!-- 5. UI Module v3.3 -->
  <script src="ui.js"></script>

  <!-- 6. UI Extensions -->
  <script src="ui-comments-extension.js"></script>
  <script src="ui-clipping-extension.js"></script>
  <script src="ui-z-offset-extension.js"></script>

  <!-- 7. OLD Lighting UI Extension - NOT NEEDED ANYMORE (commented out) -->
  <!-- <script src="ui-lighting-extension.js"></script> -->

  <!-- 8. UI Helpers (final touches) -->
  <script src="ui-helpers-modern.js"></script>

  <!-- ============================================
       INITIALIZATION SCRIPT
       ============================================ -->
  <script>
    // Flag to track if viewer has been initialized
    let viewerInitialized = false;
    let splashDismissed = false;

    // Splash screen handler - go directly to app (no login required)
    document.getElementById('enterDemoBtn').addEventListener('click', function() {
      // Track demo start with Plausible
      if (typeof plausible !== 'undefined') {
        plausible('Enter Demo');
      }
      document.getElementById('splashScreen').classList.add('hidden');
      splashDismissed = true;
      // Initialize auth (demo mode - no login)
      if (typeof BimAuth !== 'undefined') {
        BimAuth.init();
      }
    });

    window.addEventListener('load', function() {
      console.log('Page loaded, waiting for splash dismissal and authentication...');

      // Wait for splash dismissal and then initialize
      const initSystems = setInterval(function() {
        // First check if splash was dismissed
        if (!splashDismissed) {
          return;
        }

        // Check if auth is initialized (demo mode)
        if (!BimAuth || !BimAuth.initialized) {
          return;
        }

        // Check if Ion Token is available
        const ionToken = BimAuth.getIonToken();
        if (!ionToken) {
          console.log('Waiting for Cesium Ion Token...');
          return;
        }

        // Check if viewer already initialized
        if (viewerInitialized) {
          return;
        }

        console.log('User authenticated and Ion Token available');
        console.log('Initializing BIM Viewer...');

        // Apply Ion Token to Cesium BEFORE init
        if (typeof Cesium !== 'undefined' && Cesium.Ion) {
          Cesium.Ion.defaultAccessToken = ionToken;
          console.log('Cesium Ion Token applied');
        }

        // Initialize BimViewer
        if (typeof BimViewer !== 'undefined' && typeof BimViewer.init === 'function') {
          viewerInitialized = true;

          BimViewer.init().then(() => {
            console.log('BimViewer.init() completed');

            // Apply PERFORMANCE preset on startup (no shadows)
            if (typeof CONFIG !== 'undefined' && CONFIG.performance && CONFIG.performance.presets) {
              BimViewer.applyPerformanceSettings(CONFIG.performance.presets.PERFORMANCE);
              console.log('Started in PERFORMANCE mode (no shadows)');

              // Update settings dropdown to reflect PERFORMANCE preset
              const performanceSelect = document.getElementById('performancePreset');
              if (performanceSelect) {
                performanceSelect.value = 'PERFORMANCE';
              }
            }

            // Now initialize features (after viewer is ready)
            if (typeof BimViewer.initFeatures === 'function') {
              BimViewer.initFeatures();
              console.log('Features initialized');
            }

            // Initialize lighting system
            if (typeof BimViewer.initLighting === 'function' && !BimViewer.lighting) {
              BimViewer.initLighting();
              console.log('Lighting system initialized');
            }

            // Auto-load Ion assets
            if (typeof BimViewerUI !== 'undefined' && typeof BimViewerUI.autoLoadIonAssets === 'function') {
              BimViewerUI.autoLoadIonAssets();
              console.log('Auto-loading Ion assets...');
            }

            // Wait for first asset before initializing other systems
            waitForAssetAndInitSystems();

          }).catch(error => {
            console.error('BimViewer.init() failed:', error);
            viewerInitialized = false;
          });

          // Stop the interval - init started
          clearInterval(initSystems);
        }

      }, 500);
    });

    // Wait for asset to load before initializing Firebase/Comments
    function waitForAssetAndInitSystems() {
      console.log('Waiting for first asset to load...');

      const assetCheck = setInterval(function() {
        if (!BimViewer.viewer) {
          return;
        }

        // Check if at least one asset is loaded
        if (BimViewer.loadedAssets && BimViewer.loadedAssets.size > 0) {
          clearInterval(assetCheck);
          console.log('Asset detected, initializing remaining systems...');

          initializeRemainingSystems();
        }
      }, 500);

      // Also allow manual initialization after 5 seconds even without asset
      setTimeout(() => {
        if (BimViewer.viewer && !BimViewer.loadedAssets?.size) {
          console.log('No asset loaded yet, but initializing systems anyway...');
          initializeRemainingSystems();
        }
      }, 5000);
    }

    // Initialize Comments (localStorage), Hide Features, etc.
    function initializeRemainingSystems() {
      console.log('');
      console.log('INITIALIZING REMAINING SYSTEMS:');

      // Initialize Comments (localStorage - Demo Mode)
      if (typeof BimViewer.initFirebase === 'function') {
        if (BimViewer.initFirebase()) {
          console.log('Comments initialized (localStorage - Demo Mode)');
          const statusEl = document.getElementById('commentsListStatus');
          if (statusEl) statusEl.textContent = 'Ready';
        } else {
          console.log('Comments initialization failed');
          const statusEl = document.getElementById('commentsListStatus');
          if (statusEl) statusEl.textContent = 'Not initialized';
        }
      }

      // Initialize comment click handler (if not already done in features)
      if (typeof BimViewer.initCommentClickHandler === 'function' && !BimViewer.comments?.clickHandlerInitialized) {
        BimViewer.initCommentClickHandler();
        console.log('Comment click handler initialized');
      }

      // Initialize hide features
      if (typeof BimViewer.initHideFeatures === 'function') {
        BimViewer.initHideFeatures();
        console.log('Hide features initialized');
      }

      // Initialize point cloud settings
      if (typeof BimViewer.initPointCloudSettings === 'function') {
        BimViewer.initPointCloudSettings();
        console.log('Point cloud settings initialized');
      }

      console.log('');
      console.log('All systems ready!');
      console.log('Demo Mode active - user:', BimAuth.getCurrentUser()?.email);
      console.log('');
    }
  </script>
</body>
</html>
